# 実装計画

## フェーズ1: 基本インフラ構築

### タスク
- [x] CDKプロジェクトのセットアップ
- [ ] WebSocket API Gatewayの作成
- [ ] DynamoDBテーブルの作成（接続管理用）
- [ ] Lambda関数の実装
  - [ ] onConnect
  - [ ] onDisconnect
  - [ ] onSignaling（WebRTCシグナリング用）
- [ ] S3バケットの作成（フロントエンド配信用、パブリックアクセス有効）

### 成果物
- デプロイ可能なCDKスタック
- WebSocket接続が可能なAPI

## フェーズ2: フロントエンド実装

### タスク
- [ ] HTMLキャンバスの実装
- [ ] WebSocket接続処理
- [ ] 描画機能の実装
  - [ ] マウス/タッチイベントのハンドリング
  - [ ] 描画データの送信
  - [ ] 受信データの描画
- [ ] UI実装
  - [ ] ペンの色選択
  - [ ] ペンの太さ調整
  - [ ] クリアボタン

### 成果物
- 動作するお絵描きアプリ

## フェーズ3: リアルタイム同期

### タスク
- [ ] 描画データのブロードキャスト実装
- [ ] 複数ユーザーの同時描画テスト
- [ ] パフォーマンス最適化
  - [ ] 描画データの圧縮
  - [ ] バッチ送信の検討

### 成果物
- 複数人で同時に描画できるアプリ

## フェーズ4: 機能拡張（オプション）

### タスク
- [ ] ユーザー識別機能
- [ ] 描画履歴の保存
- [ ] キャンバス状態の永続化
- [ ] ルーム機能（複数のキャンバス）

## 技術的な検討事項

### WebSocketメッセージフォーマット
```json
{
  "action": "draw",
  "data": {
    "x": 100,
    "y": 200,
    "color": "#000000",
    "size": 2,
    "userId": "user-123"
  }
}
```

### DynamoDBテーブル設計

**Connectionsテーブル**
- PK: `connectionId` (String)
- Attributes:
  - `userId` (String)
  - `connectedAt` (Number)
  - `ttl` (Number) - 自動削除用

### Lambda関数の役割

**onConnect**
- connectionIdをDynamoDBに保存
- 既存ユーザーに新規接続を通知

**onDisconnect**
- connectionIdをDynamoDBから削除
- 他のユーザーに切断を通知

**onMessage**
- 描画データを受信
- DynamoDBから全接続を取得
- 全ユーザーにブロードキャスト

## コスト見積もり

### 想定使用量（開発時）
- Lambda実行: 1日1000回 × 100ms = 月3万回
- API Gateway: 1日1000メッセージ = 月3万メッセージ
- DynamoDB: 読み書き各1000回/日 = 月3万回
- S3: 1GB未満

### 予想コスト
- **ほぼ無料**（無料利用枠内）
- 開発時のみデプロイするため、月額コストはほぼゼロ

## リスクと対策

### リスク1: WebSocket接続の安定性
- 対策: 再接続ロジックの実装、エラーハンドリング

### リスク2: 同時接続数の制限
- 対策: 初期は小規模テスト、必要に応じてスケーリング

### リスク3: 描画データの遅延
- 対策: データ圧縮、バッチ送信の最適化
